<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PodPultem ‚Äì Soukrom√Ω katalog</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="description" content="Soukrom√Ω katalog produkt≈Ø ‚Äì p≈ô√≠stup jen p≈ôes tajn√Ω odkaz." />
  <!-- Strict CSP -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: data:; base-uri 'none'; form-action 'self' https://wa.me; frame-ancestors 'none'; object-src 'none'; connect-src 'self' https:; img-src 'self' https: data:; script-src 'self' https://cdn.tailwindcss.com 'unsafe-inline'; style-src 'self' 'unsafe-inline'">
</head>
<body class="bg-neutral-950 text-neutral-100 min-h-screen">
  <!-- Gate -->
  <div id="gate" class="fixed inset-0 flex items-center justify-center bg-neutral-950 p-4 hidden">
    <div class="w-full max-w-md rounded-2xl bg-neutral-900 p-6 shadow-xl border border-neutral-800">
      <h1 class="text-2xl font-semibold mb-2">Vstup jen pro zasvƒõcen√©</h1>
      <p class="text-neutral-400 mb-4">Tenhle katalog je neve≈ôejn√Ω. Otev≈ôe se jen s platn√Ωm odkazem nebo heslem.</p>
      <label class="block text-sm mb-2" for="pass">Heslo / token</label>
      <input id="pass" type="password" class="w-full px-3 py-2 rounded-lg bg-neutral-800 border border-neutral-700 focus:outline-none focus:ring-2 focus:ring-neutral-500" placeholder="Zadej heslo" />
      <button id="enterBtn" class="mt-4 w-full py-2 rounded-xl bg-white/10 hover:bg-white/20 transition">Vstoupit</button>
      <p id="gateMsg" class="text-rose-400 text-sm mt-3 hidden">Neplatn√© heslo / token.</p>
    </div>
  </div>

  <!-- App -->
  <div id="app" class="max-w-6xl mx-auto p-4 md:p-8 hidden">
    <header class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-6">
      <div>
        <h1 class="text-3xl md:text-4xl font-black tracking-tight">PodPultem</h1>
        <p class="text-neutral-400">Soukrom√Ω katalog ‚Ä¢ sd√≠lej jen s lidmi, kter√Ωm vƒõ≈ô√≠≈° üòâ</p>
      </div>
      <div class="flex flex-col sm:flex-row gap-3">
        <input id="search" class="px-3 py-2 rounded-xl bg-neutral-900 border border-neutral-800 focus:outline-none focus:ring-2 focus:ring-neutral-600" placeholder="Hledat‚Ä¶" />
        <select id="sort" class="px-3 py-2 rounded-xl bg-neutral-900 border border-neutral-800 focus:outline-none focus:ring-2 focus:ring-neutral-600">
          <option value="relevance">≈òazen√≠: Relevance</option>
          <option value="priceAsc">Cena ‚Üë</option>
          <option value="priceDesc">Cena ‚Üì</option>
          <option value="newest">Nejnovƒõj≈°√≠</option>
        </select>
      </div>
    </header>

    <main class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4" id="grid"></main>

    <!-- Drawer / Basket -->
    <div class="fixed bottom-4 right-4">
      <button id="basketBtn" class="relative px-4 py-3 rounded-2xl bg-white/10 hover:bg-white/20 border border-neutral-800 shadow-lg">
        Ko≈°√≠k / popt√°vka
        <span id="basketCount" class="ml-2 inline-flex items-center justify-center text-xs bg-neutral-100 text-neutral-900 w-6 h-6 rounded-full">0</span>
      </button>
    </div>

    <div id="drawer" class="fixed inset-x-0 bottom-0 translate-y-full transition-transform duration-300">
      <div class="mx-auto max-w-3xl bg-neutral-900 border-t border-neutral-800 rounded-t-3xl p-5 shadow-2xl">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-xl font-semibold">Tvoje popt√°vka</h2>
          <button id="closeDrawer" class="px-3 py-1 rounded-xl bg-white/10 hover:bg-white/20">Zav≈ô√≠t</button>
        </div>
        <div id="basketList" class="space-y-3 max-h-64 overflow-y-auto"></div>
        <div class="mt-4 flex flex-col sm:flex-row gap-3">
          <input id="contactField" class="flex-1 px-3 py-2 rounded-xl bg-neutral-800 border border-neutral-700" placeholder="Tvoje jm√©no / WhatsApp / IG" />
          <button id="sendWA" class="px-4 py-2 rounded-xl bg-emerald-500/90 hover:bg-emerald-500 text-neutral-900 font-semibold">Odeslat p≈ôes WhatsApp</button>
          <button id="copyMsg" class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20">Zkop√≠rovat zpr√°vu</button>
        </div>
      </div>
    </div>

    <!-- DETAIL MODAL -->
    <div id="detail" class="fixed inset-0 bg-black/70 hidden items-center justify-center p-4">
      <div class="w-full max-w-5xl bg-neutral-900 border border-neutral-800 rounded-2xl overflow-hidden shadow-2xl">
        <div class="flex items-center justify-between p-4 border-b border-neutral-800">
          <h3 id="dTitle" class="text-xl font-semibold">Detail</h3>
          <button id="dClose" class="px-3 py-1 rounded-xl bg-white/10 hover:bg-white/20">Zav≈ô√≠t</button>
        </div>
        <div class="grid md:grid-cols-2 gap-0">
          <div class="p-4 space-y-3 border-r border-neutral-800">
            <img id="dImage" class="w-full aspect-square object-cover rounded-xl" alt=""/>
            <div id="dThumbs" class="flex gap-2 overflow-x-auto"></div>
          </div>
          <div class="p-4 space-y-3">
            <div class="text-neutral-400" id="dBrand"></div>
            <div class="text-2xl font-bold" id="dName"></div>
            <div class="text-lg" id="dPrice"></div>

            <div class="flex items-center gap-2">
              <label for="dSize" class="text-sm text-neutral-400">Velikost</label>
              <select id="dSize" class="px-3 py-2 rounded-xl bg-neutral-800 border border-neutral-700"></select>
              <button id="dAdd" class="ml-auto px-4 py-2 rounded-xl bg-emerald-500/90 hover:bg-emerald-500 text-neutral-900 font-semibold">P≈ôidat do ko≈°√≠ku</button>
            </div>

            <div class="text-sm text-neutral-400">Zdroj: <a id="dUrl" href="#" target="_blank" class="underline">Odkaz na produkt</a></div>

            <div>
              <h4 class="font-semibold mb-1">Tabulka velikost√≠</h4>
              <div id="dSizesTbl" class="text-sm overflow-x-auto border border-neutral-800 rounded-xl"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer class="mt-10 text-center text-neutral-500 text-sm">
      ¬© <span id="year"></span> PodPultem ‚Ä¢ Neve≈ôejn√Ω katalog ‚Ä¢ Vytvo≈ôeno s ‚ô•Ô∏è
    </footer>
  </div>

<script>
  // ====== CONFIG ======
  const ACCESS_TOKEN = "shadow2025"; // heslo

  // P≈ôepoƒçet ceny: ¬• ‚Üí Kƒç √ó mar≈æe (+ p≈ô√≠padn√° doprava)
  const FX = { CNY_TO_CZK: 3.2, MARKUP: 1.6, SHIPPING_CZK: 0 }; // uprav dle pot≈ôeby
  const priceFromCNY = (cny) => Math.round((Number(cny||0) * FX.CNY_TO_CZK * FX.MARKUP + FX.SHIPPING_CZK) / 10) * 10;

  // ID kolekc√≠ z Raindropu (ƒç√≠seln√© ID z URL /collection/XXXX)
  const RAINDROP_COLLECTIONS = {
    "panska-tricka": "58913469",
    "mikiny": "58914294",
    "damska-tricka": "58961797",
    "opasky": "58938633",
    "kratasy": "58991599",
    "kratase": "58914666",
    "bundy": "58914670",
    "batohy": "58914676",
    "kosile": "58914766",
    "svetry": "58915821",
    "ponozky-tenisky": "58915645",
    "cestovni-tasky": "58915678",
    "kalhoty": "58937229",
    "penezenky": "58930968",
    "krabice": "58959728",
    "dlouhy-rukav": "58961878",
    "damske-tricka-dlouhy-rukav": "59011605",
    "damske-mikiny-svetry": "59011650",
    "damske-bundy-podzim-jaro": "59011725",
    "saty": "59020639",
    "destniky": "59036714",
    "damske-kratase": "59036804"
  };

  // ====== HELPERS ======
  const qs = new URLSearchParams(location.search);
  const fetchJSON = async (url) => { try { const r = await fetch(url); if(!r.ok) throw new Error('HTTP '+r.status); return await r.json(); } catch(e){ console.warn('fetchJSON', url, e); return null; } };
  const currency = (n)=> new Intl.NumberFormat('cs-CZ', { style:'currency', currency:'CZK' }).format(n);

  // Normalizace produktu z r≈Øzn√Ωch zdroj≈Ø
  function normalize(p){
    const images = Array.isArray(p.images) && p.images.length ? p.images : (p.image ? [p.image] : []);
    const url = p.url || p.link || p.source || null;
    const priceCNY = Number(p.priceCNY ?? p.price_yuan ?? p.price_cny ?? p.cny ?? 0) || null;
    const priceCZK = Number.isFinite(p.priceCZK) ? p.priceCZK : (priceCNY ? priceFromCNY(priceCNY) : null);
    const sizes = Array.isArray(p.sizes) ? p.sizes : [];
    const id = p.id || p._id || (url ? btoa(url).slice(0,10) : Math.random().toString(36).slice(2));
    return { id, name: p.name||p.title||'', brand: p.brand||'', tags: p.tags||[], images, image: images[0]||'', url, priceCNY, priceCZK, sizes, sizeTableUrl: p.sizeTableUrl||p.sizesUrl||null };
  }

  // ====== DATA LOADERS ======
  async function loadProductsFromRaindrop(){
    const ids = Object.values(RAINDROP_COLLECTIONS);
    const out = [];
    for (const id of ids){
      const data = await fetchJSON(`/api/raindrop?collections=${encodeURIComponent(id)}&token=${encodeURIComponent(ACCESS_TOKEN)}`);
      const arr = Array.isArray(data?.items) ? data.items : Array.isArray(data?.products) ? data.products : [];
      for (const raw of arr) out.push(normalize(raw));
    }
    return out;
  }

  // ====== GATE / ACCESS ======
  const token = qs.get('t') || sessionStorage.getItem('ppt_token');
  const app = document.getElementById('app');
  const gate = document.getElementById('gate');
  const passInput = document.getElementById('pass');
  const enterBtn = document.getElementById('enterBtn');
  const gateMsg = document.getElementById('gateMsg');
  function allowIn(){ gate.classList.add('hidden'); app.classList.remove('hidden'); }
  if (token === ACCESS_TOKEN) { allowIn(); } else { gate.classList.remove('hidden'); }
  enterBtn.addEventListener('click', ()=>{ if (passInput.value.trim() === ACCESS_TOKEN){ sessionStorage.setItem('ppt_token', ACCESS_TOKEN); allowIn(); } else gateMsg.classList.remove('hidden'); });
  passInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') enterBtn.click(); });

  // ====== APP STATE & UI ======
  const grid = document.getElementById('grid');
  const search = document.getElementById('search');
  const sort = document.getElementById('sort');
  const basketBtn = document.getElementById('basketBtn');
  const drawer = document.getElementById('drawer');
  const closeDrawer = document.getElementById('closeDrawer');
  const basketList = document.getElementById('basketList');
  const basketCount = document.getElementById('basketCount');
  const contactField = document.getElementById('contactField');
  const sendWA = document.getElementById('sendWA');
  const copyMsg = document.getElementById('copyMsg');

  // detail modal
  const detail = document.getElementById('detail');
  const dClose = document.getElementById('dClose');
  const dTitle = document.getElementById('dTitle');
  const dBrand = document.getElementById('dBrand');
  const dName = document.getElementById('dName');
  const dPrice = document.getElementById('dPrice');
  const dImage = document.getElementById('dImage');
  const dThumbs = document.getElementById('dThumbs');
  const dUrl = document.getElementById('dUrl');
  const dSize = document.getElementById('dSize');
  const dAdd = document.getElementById('dAdd');
  const dSizesTbl = document.getElementById('dSizesTbl');

  let state = { q: '', sort: 'relevance', items: [], basket: [], current: null };

  function render(){
    const q = state.q.toLowerCase();
    let items = state.items.filter(p =>
      (p.name || '').toLowerCase().includes(q) ||
      (p.brand || '').toLowerCase().includes(q) ||
      (p.tags || []).some(t => String(t).toLowerCase().includes(q))
    );

    if (state.sort === 'priceAsc') items.sort((a,b) => (a.priceCZK??Infinity) - (b.priceCZK??Infinity));
    if (state.sort === 'priceDesc') items.sort((a,b) => (b.priceCZK??-Infinity) - (a.priceCZK??-Infinity));
    if (state.sort === 'newest') items.sort((a,b) => (String(b.id) > String(a.id) ? 1 : -1));

    grid.innerHTML = items.map(p => `
      <article class="rounded-2xl overflow-hidden bg-neutral-900 border border-neutral-800 shadow">
        <button class="w-full text-left" data-detail="${p.id}">
          <div class="aspect-[4/3]"><img src="${p.image}" alt="${p.name}" loading="lazy" class="w-full h-full object-cover"/></div>
        </button>
        <div class="p-4">
          <div class="text-sm text-neutral-400">${p.brand || ''}</div>
          <h3 class="text-lg font-semibold">${p.name || ''}</h3>
          <div class="flex items-center justify-between pt-1">
            <span class="font-bold">${Number.isFinite(p.priceCZK)?currency(p.priceCZK):'Na dotaz'}</span>
            <div class="flex gap-2">
              <button data-id="${p.id}" class="addBtn text-xs px-3 py-1.5 rounded-lg bg-emerald-500/90 hover:bg-emerald-500 text-neutral-900 font-semibold">P≈ôidat</button>
              <button data-detail="${p.id}" class="text-xs px-3 py-1.5 rounded-lg bg-white/10 hover:bg-white/20">Detail</button>
            </div>
          </div>
        </div>
      </article>
    `).join('');

    // add handlers
    grid.querySelectorAll('.addBtn').forEach(btn=>{
      btn.onclick = () => { const id = btn.getAttribute('data-id'); addToBasket(id); };
    });
    grid.querySelectorAll('[data-detail]').forEach(el=>{
      el.onclick = () => { const id = el.getAttribute('data-detail'); openDetail(id); };
    });
  }

  function addToBasket(id, chosenSize){
    const prod = state.items.find(x => String(x.id) === String(id));
    if (!prod) return;
    const key = id + (chosenSize?`@${chosenSize}`:'');
    if (!state.basket.find(x => x.key===key)) state.basket.push({ key, ...prod, size: chosenSize||null, qty: 1 });
    basketCount.textContent = String(state.basket.length);
    renderBasket();
  }

  async function openDetail(id){
    const p = state.items.find(x => String(x.id) === String(id));
    if (!p) return;
    state.current = p;
    dBrand.textContent = p.brand || '';
    dName.textContent = p.name || '';
    dTitle.textContent = p.name || 'Detail';
    dPrice.textContent = Number.isFinite(p.priceCZK)?currency(p.priceCZK):'Na dotaz';
    dUrl.href = p.url || '#';

    // gallery
    const imgs = p.images && p.images.length ? p.images : (p.image?[p.image]:[]);
    dImage.src = imgs[0] || '';
    dThumbs.innerHTML = imgs.map((src,i)=>`<img src="${src}" class="w-16 h-16 object-cover rounded-lg cursor-pointer border border-neutral-800" data-img="${i}">`).join('');
    dThumbs.querySelectorAll('[data-img]').forEach(t=> t.onclick = ()=>{ dImage.src = imgs[Number(t.getAttribute('data-img'))]; });

    // sizes select
    dSize.innerHTML = (p.sizes && p.sizes.length ? p.sizes : ['XS','S','M','L','XL']).map(s=>`<option>${s}</option>`).join('');

    // size table fetch
    dSizesTbl.innerHTML = '<div class="p-3 text-neutral-400">Naƒç√≠t√°m‚Ä¶</div>';
    const srcForSizes = p.sizeTableUrl || p.url;
    if (srcForSizes){
      const res = await fetchJSON(`/api/sizechart?url=${encodeURIComponent(srcForSizes)}&token=${encodeURIComponent(ACCESS_TOKEN)}`);
      if (res?.html){
        dSizesTbl.innerHTML = res.html; // oƒçek√°v√°me serverem oƒçi≈°tƒõn√© <table>
      } else if (Array.isArray(res?.rows)) {
        // fallback z JSONu
        const head = res.headers || [];
        const rows = res.rows || [];
        const th = head.map(h=>`<th class="px-2 py-1 border border-neutral-800">${h}</th>`).join('');
        const tr = rows.map(r=>`<tr>${r.map(c=>`<td class=\"px-2 py-1 border border-neutral-800\">${c}</td>`).join('')}</tr>`).join('');
        dSizesTbl.innerHTML = `<table class="min-w-full text-left">${head.length?`<thead><tr>${th}</tr></thead>`:''}<tbody>${tr}</tbody></table>`;
      } else {
        dSizesTbl.innerHTML = '<div class="p-3 text-neutral-400">Tabulka nedostupn√°.</div>';
      }
    } else {
      dSizesTbl.innerHTML = '<div class="p-3 text-neutral-400">Tabulka nedostupn√°.</div>';
    }

    detail.classList.remove('hidden');
    detail.classList.add('flex');
  }

  dClose.onclick = () => { detail.classList.add('hidden'); detail.classList.remove('flex'); };
  dAdd.onclick = () => { if (!state.current) return; addToBasket(state.current.id, dSize.value); };

  function renderBasket(){
    if (!state.basket.length){
      basketList.innerHTML = '<div class="text-neutral-400">Ko≈°√≠k je pr√°zdn√Ω.</div>';
      return;
    }
    basketList.innerHTML = state.basket.map(it => `
      <div class="flex items-center gap-3 p-2 rounded-xl bg-neutral-800 border border-neutral-700">
        <img src="${it.image || ''}" class="w-14 h-14 object-cover rounded-lg" loading="lazy"/>
        <div class="flex-1">
          <div class="text-sm text-neutral-400">${it.brand || ''}</div>
          <div>${it.name || ''}${it.size?` ‚Ä¢ ${it.size}`:''}</div>
          <div>${Number.isFinite(it.priceCZK) ? currency(it.priceCZK) : 'Na dotaz'}</div>
        </div>
      </div>
    `).join('');
  }

  function buildMessage(){
    const lines = [];
    lines.push('*Popt√°vka ‚Äì PodPultem*');
    const contact = (contactField.value || '').trim();
    if (contact) lines.push(`Kontakt: ${contact}`);
    state.basket.forEach(it=>{
      const price = Number.isFinite(it.priceCZK) ? currency(it.priceCZK) : 'Na dotaz';
      lines.push(`‚Ä¢ ${it.name} (${it.brand}) ${it.size?`[${it.size}]`:''} √ó ${it.qty} ‚Äì ${price}`);
      if (it.url) lines.push(`   ${it.url}`);
    });
    return lines.join('
');
  }

  // Start ‚Äì naƒçti z Raindropu a pak vyrenderuj
  (async () => {
    try { state.items = await loadProductsFromRaindrop(); }
    catch (e) { console.error('Raindrop API spadlo:', e); state.items = []; }
    render();
  })();

  // ====== Handlery ======
  search.oninput  = (e)=>{ state.q = e.target.value; render(); };
  sort.onchange   = (e)=>{ state.sort = e.target.value; render(); };

  basketBtn.onclick = () => { drawer.style.transform = 'translateY(0)'; renderBasket(); };
  closeDrawer.onclick = () => { drawer.style.transform = 'translateY(100%)'; };

  sendWA.onclick = () => { const msg = encodeURIComponent(buildMessage()); window.open(`https://wa.me/?text=${msg}`, '_blank'); };
  copyMsg.onclick = async () => { try { await navigator.clipboard.writeText(buildMessage()); copyMsg.textContent = 'Zkop√≠rov√°no ‚úì'; setTimeout(()=> copyMsg.textContent = 'Zkop√≠rovat zpr√°vu', 1500); } catch { alert('Nepoda≈ôilo se zkop√≠rovat.'); } };

  document.getElementById('year').textContent = new Date().getFullYear();
</script>
</body>
</html>





